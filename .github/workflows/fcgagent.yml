name: Build FCGAgent

on:
  workflow_dispatch:

permissions:
  packages: write
  contents: read

jobs:
  build:
    runs-on: [self-hosted]   # use your self-hosted Windows runner
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

#      - name: Install ORAS
#        shell: powershell
#        run: |
#          winget install --id ORASProject.ORAS -e --accept-source-agreements --accept-package-agreements

      - name: Debug if secret exists
        shell: powershell
        run: |
          if ([string]::IsNullOrEmpty("${{ secrets.MYREPO_PAT }}")) {
            Write-Error "❌ MYREPO_PAT is missing or unavailable!"
          } else {
            Write-Host "✅ MYREPO_PAT is present"
          }

      - name: Login to GHCR
        shell: cmd
        env:
          MRP_PAT: ${{ secrets.MYREPO_PAT }}
          USER: ${{ github.actor }}
        run: |
          echo %MRP_PAT% | oras.exe login ghcr.io -u %USER% --password-stdin
          oras push ghcr.io/%USER%/CaevesInstaller/caeves-fcg-app-release:1.0 "c:\CAEVES.FCG.App_Release_2025-12-04_00-55.msi:application/octet-stream"

      - name: Show uploaded package info
        env:
          USER: ${{ github.actor }}
        run: |
          oras repo ls ghcr.io/%USER%/CaevesInstaller
